---
layout:         post
title:          思科路由学习笔记2
description:    管理思科互联网络
keywords: Cisco Router,Cisco IOS
---

#### **1、思科路由器的内部组件**

|  组件  | 描述   |
|:-----:|:-------|
|引导程序|存储在Rom中的微代码，主要作用是在路由器初始化的时候启动它。引导程序将启动路由器并加载IOS|
|POST(开机自检)|存储在ROM中的微代码，用于检测路由器硬件的基本功能，并确定可用的接口|
|ROM监控程序|存储在ROM中的微代码，用于制造、检测和故障测试|
|微型IOS|被思科称为RXBOOT或引导程序，是一个存贮在ROM中的小型IOS,用于启动一个接口并将思科IOS加载到内存中。微型IOS也可以执行一些其他的维护操作|
|RAM|用于存储分组缓存、ARP缓存、路由表以及路由器运行所需要的软件和数据结构。运行配置保存在RAM中，并且多数路由器都是咋启动时将IOS从内存中加载并释放到RAM运行的|
|ROM|用于启动和维护路由器的正常运行。其主要功能是POST、引导程序和微型IOS|
|闪存|默认保存路由器的IOS。闪存的内容不会在路由器重启时删除。|
|NVRAM(非易失性RAM)|用于存储路由器和交换机的配置内容。配置寄存器存储在这里|
|配置寄存器|用于控制路由器的启动方式。配置寄存器的值在sh version 最后一行给出。默认0x2102|

#### **2、路由器启动顺序**

> 加载IOS的默认顺序是闪存、TFTP服务器，然后是ROM。

#### **3、管理配置寄存器**

> 思科路由器都有一个写入NVRAM中的16位可软件编程的寄存器。

##### **3.1、 理解配置寄存器的位**

> 配置寄存器数值的读取方式是从15读到0，即从左读到右。

|取值|8|4|2|1|8|4|2|1|8|4|2|1|8|4|2|1|
|-----|-----|-----|------|-------|
|位值|15|14|13|12|11|10|9|8|7|6|5|4|3|2|1|0|
|0x2102|0|0|1|0|0|0|0|1|0|0|0|0|0|0|1|0|

> 例如:0x2102 代表13、8、1的位的值为1

> 0~3位代表启动字段。6位为1的话启动时忽略NVRAM的内容。

##### **3.2、检测配置寄存器的值**

> show version 最后一行显示配置寄存器的值。

##### **3.3、修改配置寄存器**

> 注：在对配置寄存器进行改动之前，一定要确信已经知道配置寄存器的当前值。

> 在全局配置模式下，用config-register 命令可以配置寄存器的值。
  例子: config-registe 0x2140
  
##### **3.3、密码恢复**

> 当忘记路由器的登录密码时，可通过改动配置寄存器的值来恢复对路由器的正常访问。

 
> 进行密码恢复的主要步骤：

>  + 启动路由器，并通过中断操作(console 通过ctrl +_break)中止启动过程，将路由器引导至ROM模式。

  + 改配置寄存器，将第六位的取值置1(即设为0x2142)。(ISR/2600系列:confreg 0x2142,2500系列:o/r 0x2142。)

  + 重启路由器。(2600系列:I或reset,2500系列：I)

  + 进入特权模式

  + 将启动配置文件复制为运行配置文件。(copy start run)

  + 修改密码(enable password/secret xx)

  + 将配置寄存器的值恢复为默认。(config-register 0x2102)

  + 保存修改后的路由器配置。

  + 重启路由器(可选)。


##### **3.5、boot system 命令**

> boot system: 允许指定路由器使用闪存中某个文件进行引导。

#### **4、备份和恢复思科IOS**

##### **4.1、验证闪存**

> show flash:查看闪存的使用情况和文件详细。

##### **4.2、备份思科IOS**

> copy flash tftp:将思科IOS备份到tftp服务器上。

##### **4.3、恢复或升级思科路由器的IOS**

> copy tftp flash: 从tftp服务器复制文件到思科路由器的flash。

> 我们可以将思科路由器配置成一个在闪存中运行，用于提供路由器系统文件的tftp主机服务器主机，实现这一配置的全局命令是：tftp-server flash:ios_name;

##### **4.4、使用思科IOS文件系统**

> 思科开发一种称为Cisco IFS(IOSFile System)的文件系统。

> 该系统的命令有dir,copy,more,delete,erase或format,cd和pwd,mkdir和rmdir。这些命令和linux的命令使用方法类似。

> **注:** 凡涉及内存的操作一定要小心谨慎。

##### **5、备份和恢复思科配置**

##### **5.1、备份思科路由器配置文件**

> 验证当前配置:sh running-config(sh run)

> 验证已存储的配置: sh startup-config

> 复制当前配置到NVRAM：copy runnint-config startup-config(copy run sh)

> 复制到tftp服务器:copy running-config tftp (copy run tftp)

##### **5.2、恢复思科路由器的配置**

> copy startup-config running-config (copy start run)

> copy tftp running-config (copy tftp run)

> **注：** 当某个路由器的配置文件刚被删除且又重新启动，我们需要从TFTP服务器上复制或修改整合配置文件到路由器的RAM中。注意，默认情况下路由器的接口是关闭的，我们必须使用no shutdown 命令手动启用每个需要进行网络连接的接口。

##### **5.3 删除配置**

> erase startup-config

> 删除NVRAM中的内容。此时如果在特权模式下输入reload并选择不保存所做的修改，路由器被重启时进入设置模式。

#### **6、使用思科发现协议**

> CDP(Cisco Discovery Protocol,思科发现协议)是思科设计的专用协议，它可以帮助管理员手机关于本地附件和远程连接设备的相关信息。通过CDP,我们可以获取相邻设备上的硬件和协议信息。

##### **6.1 获取CDP定时器和保持时间的相关信息**

> show cdp 提供两个cdp全局参数相关信息。分别是cdp 定时器(timer)、cdp保持时间(holdtime)。

> cdp timer/holdtime :配置cdp的定时器/保持时间。(packet tracer 6.0及以上无法使用这个命令，不知啥原因。)

##### **6.2 收集邻居信息。**

> show cdp neighbors [detail]:显示直接连接设备的相关信息[详细信息]。

> show cdp entry * : 与show cdp neighbors detail 提供消息相同

> show cdp entry * protocols/version:显示出每个直接连接设备的IP地址/运行的IOS版本信息。

##### **6.3 获取接口上流量信息**

> show cdp traffic:显示有关接口流量的信息，包括发送和接收到的CDP分组的数量，以及CDP错误。

##### **6.4 获取端口和接口的相关信息**

> show cdp interface :显示路由器接口或交换机端口上的CDP状态。

##### **6.5 使用cdp记录网络拓扑结构**

> 根据 **show running-config**和**show cdp neighbors**命令提供的所有信息，我们就可以创建一个网络的拓扑图。

> 链路层发现协议: 一个可以运行在多个厂商网络环境中，用于与cdp提供几乎相同信息的协议。(802.1AB标准,LLDP)。

#### **7、使用Telnet**

> telnet 10.1.1.1:跟我们平时使用的telnet没什么区别

> **注:**如果发现不能远程登录某台设备，有可能就是在远程设备上面没有进行密码设备。当然，如果是使用了访问控制列表，也有可能是它过滤了这个远程登录的会话。

> 远程登录一个设备时，默认情况下我们是不会看到控制台信息的。为了允许将控制台信息发送到Telnet会话，我们应可以使用terminal monitor 命令。

##### **7.1 同时登录多台设备**

>  我们远程登录某台路由器或者交换机后，如果想返回原路由器控制台，可以按Ctrl+Shift+6,再释放，让后再按下X键。

##### **7.2 检查Telnet连接**

> sh sessions:查看路由器到远程设备的连接

##### **7.3 检查Telnet用户**

> sh users:产看路由器上正在使用的控制台和所有连接中的vty窗口。

##### **7.4 关闭Telnet 会话**

> exit 或者disconnect

#### **8、解析主机名**

> 有两种方法实现主机名到IP地址的解析：在每个路由器上建立一个主机表或者组建一个DNS。

##### **8.1 建立主机表**

> ip host host_name [tcp_port_number] ip_address

> 例: ip host RouterA 192.168.1.1

> show hosts：可以查看主机表相关信息。它提供有关表项的flags属性信息，它可以区分出临时性的DNS表项以及永久性的由ip host 命令创建的名称到地址映射的表项。

> no ip host RouterA :从主机表删除RouterA

##### **8.2 使用DNS解析名称**

> 如果网络上已经配备DNS服务器，为了让DNS的名称解析服务起作用，还需运行以下相关命令：

> + ip domain-lookup。此命令是默认开启的(关闭 no ip domain-lookup)
+ ip name-server。用于设置Dns服务器的IP地址。
+ ip domain-name。这个命令是可选的，但还是有必要设置它。它负责将域名附加到输入的主机名后。

#### **9、检查网络连接并排除故障**

##### **9.1 使用Ping命令**

> 没啥好说的，这个经常用

##### **9.2 使用traceroute命令**

> 显示分组到达远程设备的路径。

##### **9.3 debug命令**

> 常用于显示各种路由器操作的信息以及由路由器产生或接收到的与流量相关的信息，此外还包括出错信息。这是一个需要高开销的命令。

##### **9.4 使用show processes命令**

> 这个命令可以显示CPU的利用率。此外，还提供正在运行进程的列表，以及进程的ID、优先权、调度程序测试(状态)、使用CPU时间、调用次数等数据。
