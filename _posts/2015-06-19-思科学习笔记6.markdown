---
layout:         post
title:          思科路由学习笔记6
description:    虚拟局域网
keywords: VLAN VTP 
---


#### **1 概述**
 默认情况下，交换机分割冲突域，而路由器分割广播域。在纯粹交换型互联网络中，可以通过创建虚拟局域网(VLAN)来分割广播域。VLAN是一个网络用户和网络资源的逻辑分组。
 
#### **2 VLAN基础**
  默认情况下，路由器只允许广播在始发网段中传输，而交换机将广播转发到所有网段。
  
  VLAN简化网络管理的方式：
  
  * 在网络中添加、移除、更换设备很容易，只需将端口加入合适的VLAN即可；
  * VLAN可独立于用户的地理位置；
  * 极大改善网络安全；
  * **VLAN增加广播域的数量，同时缩小广播域的规模**.
  
#### **3 VLAN成员资格**

###### **3.1 静态VLAN**
  将交换机端口分配给VLAN，称为静态VLAN。
  
  静态VLAN易于配置和管理，非常适合于需要控制所有用户移动的网络环境。
  
###### **3.2 动态VLAN**

  通过使用智能管理软件，可根据硬件(MAC)地址、协议甚至创建VLAN应用程序来确定节点所属VLAN。
  
#### **4 标志VLAN**

 在交换环境中，存在两种类型的端口，一种是**接入端口**(只属于一个VLAN，且只为该VLAN传输数据)，另外一种是**中继端口**(可同时传输多个VLAN的数据流)
 
###### **4.1 对帧进行标记**

在每个帧中添加用户自定义的VALN ID，称为帧标记。

帧标记原理:进入交换构造后，帧到达的每台交换机都首先从帧标记中获取VLANID，然后查看过滤表中的信息，以确定如何对帧进行处理。如何帧到达的交换机还有另一条中继链路，将被从该中继链路的端口转发出去。

###### **4.2 VLAN标识方法**

* 交换机链路(ISL)
  
  ISL是一种显示标记方法，它在以太网帧中添加VLAN信息。ISL工作在第二层，它使用新的报头和循环冗余校验(CRC)封装数据帧。
  
  ISL是**思科专用协议**，只能用于快速以太网和吉比特以太网。
  
* IEEE 802.1Q

  由IEEE制定的一种帧标记标准，它在帧中插入一个字段，用于标记VLAN。
  
  帧标记方法用途:提供交换机间VLAN通信。另外，将帧转发到接入链路前，将删除ISL或者802.1Q帧标记---标记只用于中继链路内部。
  
#### **5 VLAN中继协议(VTP)**

  VTP 由思科开发，是思科专有协议。VTP的基本目标:管理交换型互联网络中配置的所有VLAN，确保整个网络的一致性。

  两台交换机要交换VLAN信息，必须满足如下三个条件:
  
  * 两台交换机的VTP管理域名相同；
  * 其中一台交换机配置为VTP服务器；
  * VTP密码相同(如果使用的话)。
  
###### **5.1 VTP运行模式**

VTP有三种VTP模式:服务器模式，客户端模式，透明模式，**默认情况下交换机都处于服务器模式**。


* 服务器模式: 处于服务器模式下的交换机才能在VTP域中创建、添加和删除VLAN。修改VLAN信息也必须在该模式下进行；在该模式下，交换机对VLAN所作的修改都将被通告给整个VTP域。**VLAN配置存储在交换机的NVRAM中**。

* 客户端模式：能接收来自VTP服务器的信息，并转发更新；不能创建、修改或删除VLAN。另外，只能将客户端交换机的端口加入到其VLAN数据库中已有的VLAN中；它**不会将来自VTP服务器的VLAN信息存储到NVRAM中**；要让交换机成为服务器，应首先让其成为客户端，以便节后正确的VLAN信息，再切换到服务器。总结：处于VTP客户端模式的交换机只熟悉并转发VTP信息，仅此而已。

* 透明模式：处于该模式下的交换机，不加入VTP，也不分享其VLAN数据库，而只通过中继链路转发VTP通告。它可创建、修改和删除VLAN，因为它保存自己的数据库，且不会将其告诉其他交换机。将**VLAN数据库保存在NVRAM中**。设计透明模式唯一目的：**让远程交换机能通告未加入当前VTP域的交换机从VTP服务器那里接收VLAN数据库**。


VLAN只获悉常规VLAN(ID为1~1005的VLAN)，ID大于1005的称为扩展VLAN，不会保存在VLAN数据库中。要创建ID为1006~4094的VLAN，交换机必须处于VTP透明模式。

###### **5.2 VTP修剪**

启用VTP修剪，可以将广播转发给确实需要它的中继链路，这样可以减少广播、组播和单播分组，从而节省带宽。

可修剪的VALN为VLAN2~1001；

#### **6 VLAN路由**

让不同的VLAN之间的主机能够彼此通信，就必须使用第三层设备来提供路由选择功能。为此，可使用能为每个VLAN提供一个接口的路由器；也可以不给每个VLAN提供一个接口，只使用一个以太网接口，并在该接口运行ISL或者802.1Q(通过子接口),思科称之为“单臂路由器”。

#### **7 配置VLAN**

* 创建VLAN：使用全局命令vlan

  例子： 
       vlan 2
       name Marketing
  
  不能修改、删除或者重命名VLAN1，因为它是默认VLAN。
  
* 查看VLAN： show vlan

* 将交换机端口分配给VLAN：可使用接口命名switchport;要配置多个，可使用interface range。

  例子：
      int f0/0 或者 int range f0/0-10
      switchport mode access vlan 2
      
* 配置中继端口：可使用switchport mode trunk

  在三层交换机中，还必须指定封装方法:ISL或者802.1Q;

  指定端口支持的VLAN： switchport trunk allowed valn all/add/remove

  修改本机端口VLAN：switchport trunk native vlan 40

  中继链路两端的本机VLAN必须相同。

* 配置VLAN间路由选择

  在以太网接口上支持ISL或者802.1Q，将这种接口分成多个逻辑接口，每个VLAN一个，这些逻辑接口成为**子接口**。
  
  例子:
      int f/0.1;  
      encapsulation dot1q.2
      ip address 192.168.1.1 255.255.255.0
 
#### **8 配置VTP**

  创建VTP时，可设置多个方面包括：域名，密码，运行模式和修剪。
  
  设置vtp模式:vtp mode server/client/transparent
  
  设置vtp域名:vtp domain Lammel(区分大小写)

  设置vtp密码：vtp password todd
  
  查看vtp状态:show vtp status(会指出交换机支持多少个VLAN)
