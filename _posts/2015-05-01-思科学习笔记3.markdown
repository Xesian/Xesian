---
layout:         post
title:          思科路由学习笔记3
description:    IP路由
keywords: RIP,IP router
---

#### **1、路由选择基础**

> 路由选择指将分组从一个设备通过互联网络发往位于不同网络上的另一个设备的操作。路由器不关注网络中的主机，而只关注互联起来的网络和通往各个网络的最佳路径。目标主机的**逻辑网络**用来获取通过可路由的网络传送到指定网络中的分组，主机的硬件地址用来将分组从路由器传递到正确的目标主机上。

> 如果某个网络与路由器是直接相连的，那么路由器自然知道如何到达这个网络。如果某个网络没有与路由器直接相连，那么路由器就必须通过两种方式了解如何到达这个远程网络：**静态路由选择和动态路由选择**。在大型的网络中，静态路由和动态路由通常会被同时使用。

#### **2、IP路由选择过程**

> + 主机中的IP协议将来自应用层的数据封装成IP包，即创建一个IP包；
+ IP协议判断目标IP地址的位置，判断此目的方位于本地网络还是某个远程网络；
+ 若位于本地网络，则将IP包直接转发到目的网络，否则，进行下一步；
+ 若这是一个远程的跨网络请求，而要将这一分组路由到远程网络，就必须将它发给默认网关。
+ 主机检查ARP缓存，查看默认网关的IP地址是否已被解析一个硬件地址。如被解析，进行下一步，如没被解析，则用于查找默认网关的的硬件地址的ARP广播将被发送到本地网络，默认网关会回应这个请求。
+ 主机知道了默认网关的MAC地址，将分组和目的方的硬件地址交给数据链路层，局域网驱动程序负责选用适合所在局域网类型的介质访问方式。通过将控制信息封装到此分组上的帧(一般是以太网帧)被创建了。
+ 一旦帧创建完成，这个帧将交付给物理层，物理层会以一次一比特的方式将帧发送到物理介质上。
+ 冲突域中的每台设备都会接收到帧，并将它们重新组建成帧。每个设备都会对接收的内容进行CRC运算，并与帧中FCS字段的内容进行比对。如果值不匹配，接收到的帧将被丢弃。如果匹配，则接下来查看以太网类型的字段，以获悉完成数据后续处理的网络协议。
+ 将分组从帧中抽出，并将其他部分丢弃。然后，分组被递交给以太网类型字段中烈火粗的协议，一般是IP协议。
+ IP将接收这个分组，并检查它的IP目的地址。路由器会在路由表中查找目的方的IP网络地址。
+ 如果路由选择表中包含目的方IP网络的相关表项，则分组将被交换到知道那个的输出接口。若没有相关表项，则路由器会立即将收到的分组丢弃，并同时向发送数据的源方设备回送一个携带有目标网络不可达信息的ICMP报文。
+ 经过n个路由，分组到达目的方网络。
+ 目的方的路由器获取目的ip的mac地址(没有的话通过arp协议获取)。随后分组和目的方的硬件地址都会被传递给数据链路层，用以组装成帧。
+ 数据链路层将目的硬件地址，源目的地址，以太网字段类型以及帧尾部的FCS字段创建帧。之后这个帧被叫到物理层。并由物理层以逐比特的方式发送到物理介质上。
+ 目的IP的主机接收到这个帧，并立即运行CRC。如果运算的结果与FCS字段的内容匹配，则检查帧中的目的硬件地址。如果主机认为是匹配的，则检查帧中以太网类型字段的值，将分组递交给相应的上层网络。
+ 在网络层，IP接收这个分组，并对IP报头运行CRC。如果校验通过，IP随后将检查分组中的目的地址。如果匹配，则根据协议类型上交上层的应用层程序。

##### **2.1 配置路由器接口的IP地址。**

一般四步走：

> + interface s0/0/0或者f0/0
+ ip address 192.168.1.1 255.255.255.0
+ no shutdown
+ description XXX

#### **3、在网络上配置IP路由**

##### **3.1 静态路由配置**

优点：

> + 不增加路由器cpu的开销；
+ 不增加路由器的带宽占用，也就是说在WAN链接的使用中可以节省更多的费用；
+ 提高安全性

缺点：

> + 管理员必须正确了解整个互联网络以及每台路由器的连接方式，以便实现对这些路由器的正确配置；
+ 当添某个网络到互联网络中，管理员必须在所有路由器上手工添加此网络的路由；
+ 对于大型网络使用静态路由选择基本上是不行的，因为配置静态路由会产生巨大的工作量。

静态路由添加到路由选择表中的命令语法：

> ip route [destination_network] [mask] [next_hop_address Or exitinterface] [administrative_distance] [permanent]

> permanent:如果接口被关闭后者路由器不能与下一跳路由器通信，默认情况下这一路由将会被从路由选择表中自动删除。这个选项，将导致在任何情况下都**保留**这一路由选择表项在路由选择表中。

> 例子：ip route 192.168.1.0 255.255.255.0 10.1.4.1 150

##### **3.2 默认路由选择**

> 使用默认路由选择，我们可以转发那些远程目的网络不在**路由选择表**中列出的分组到下一跳路由器。在设计网络时默认路由器选择的配置需具体问题具体分析。

> ip route 0.0.0.0 0.0.0.0 10.5.4.1(fa0/0)

> ip classless


> 关于 ip classless:几乎所有的思科路由器都是有类路由器，也就是说，路由器的每个接口**预设**了使用默认的子网掩码。当路由器接收到一个目的子网不在路由选择表中的分组时，默认将**丢弃**这个分组。因此，如果在配置中**使用默认路由器，这里就必须使用ip classless命令**，因为在路由选择表中可能没有远程网络的子网。为什么？因为那些路由选择表中非默认路由的表项具有相同子网类别的子网在转发时会忽略默认路由的存在，而使用这个命令就基本在说：”嘿，IP！在你丢弃分组之前，请确认一下最终网关是否已经配置“。(ios版本12.4以上，这个命令处于启用状态)

#### **4、动态路由选择**

> 动态路由选择就是路由器**根据协议**查找网络并更新路由选择表。

##### **4.1 路由选择协议基础**

###### a.管理距离(AD,Administrative Distance)

> 用来衡量路由器已收到的、来自**相邻路由器**的路由选择信息的**可信度**。管理距离可以使0~255之间的整数，其中0表示最可信赖，255则意味着不会有通信量通过这个路由。


> 如果路由器接收了两个对同一远程网络的更新信息，路由器首先检查更新信息的AD。如果被通告的路由器中有一个的AD值比另一个低，那么这个拥有较低的AD值的路由将被放置在路由选择表中。

默认的管理距离： 

|路由源|默认AD|
|:---|:----|
|直连接口|0|
|静态路由|1|
|EIGRP|90|
|IGRP|100|
|OSPF|110|
|RIP|120|
|外部EIGRP|170|
|未知|255(不会被使用)|

###### b.路由选择协议

> 距离矢量：通过判断距离确定当前到达远程网络的最佳路径。矢量用于致命远程网络所在的方向。

>链路状态：又称最短路径优先协议，路由器将菲比创建3个彼此独立的表(邻居表，拓扑表、路由选择表)。链路状态协议将包含自身连接状态的更新发送到网络中其他所有直接连接的路由器上，然后再由这些路由器传播到他们的相邻设备。

> 混合型：同时具有距离矢量和链路状态两种协议的特性，如EIGRP。

#### **5、距离矢量路由选择协议**

> 距离矢量路由选择算法发送完整的路由选择表内容到相邻的路由器，然后相邻的路由器将接收到的路由选择表项与它们原有的路由选择表项合并，以完善自己的路由选择表。

> RIP 协议只使用跳计数判定到达某个网络的最佳路径。。如果RIP发现对于同一个远程网络存在具有多个相同的跳计数的链路，则RIP将自动执行循环负载均衡。RIP可以对多大6个（默认4个）等价链路实现负载均衡。

###### 路由环路

> 当某个网络瘫痪时，由于距离矢量路由选择协议的慢收敛(会聚)，最终导致不一致的路由选择表和路由环路。

> 阻止路由环路:

> + 最大跳计数：RIP定义最大跳计数为15.
+ 水平分割：禁止路由选择协议回传路由选择信息；
+ 路由中毒:当一个网络出现故障时，相关的路由器通过到达该网络的跳计数为16或不可达(有时被视为无穷大)，以此启动路由中毒。
+ 保持关闭:阻止常规的更新消息恢复一个不断的打开又关闭(称为翻转)的路由。


#### **6、RIP**

> RIP是一个纯粹的距离矢量路由选择协议。RIP每个30s就将自己的完整的路由选择表从所有激活的接口上送出。RIP只将跳计数作为判断到达远程网络最佳路径的依据，并且在默认情况下允许的最大跳计数为15,16认为是不可达的。

> RIP 版本1 只使用有类的路由选择，即网络中的所有设备都不必须使用相同的子网掩码。这是因为RIP版本1中在其发送的更新数据中不携带子网掩码信息。RIP版本2提供了前缀路由选择信息，并可以在路由更新中传送子网掩码信息。这就是无类的路由选择。

###### **6.1、RIP定时器**

> 路由更新定时器：用于设置路由更新的时间间隔(默认30s)，此间隔是路由器发送自己路由选择表的完整副本给所有相邻路由器的时间间隔。

> 路由失效定时器:用于路由器最终认定一个无有效路由之前需要等待的时长(通常为180s)。

> 保持失效定时器：用于设置路由选择信息被抑制的时长。当一个路由器收到摸个表示路由不可达的更新分组时，它将进入保持失效状态。

> 路由刷新定时器：用于设置将某个路由认定为无效路由起至将它从路由选择表删除的时间间隔(通常为240s)。

###### **6.2 配置RIP路由选择**

> 通过使用router rip 和network命令，就可以将RIP路由选择协议添加到配置中。network命令用于告诉此路由选择协议需要对哪些有类网络进行通告。

> 记住：在配置网络地址时RIP要求使用有类地址。

###### **6.3 检验RIP路由选择表**

> sh ip route

###### **6.4 抑制RIP传播**

> passive-interface f0/0 :在指定的接口上阻止RIP更新的对外广播，同时又不影响该接口对RIP更新的接收。

###### **6.5 RIPV2**

> router rip

> version 2（启用rip版本2，支持VLSM和不连续网络）

#### **7、验证配置**

> shoow ip route

> show ip protocols

> debug ip rip

###### show ip protocols

> 显示在路由器上已配置的路由选择协议。


###### debug ip rip

> 将路由器上正在发送和接收的路由更新显示到控制台会话中。如果是远程登录的，则使用terminal monitor 命令接收debug命令的输出。