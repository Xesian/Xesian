---
layout:         post
title:          思科路由学习笔记5
description:    第二层交换和STP
keywords: STP
---

#### **1、概述**

> 所谓第二层交换，指在LAN上使用设备的硬件地址对网络进行分段的过程。交换技术用来**将大的冲突域分隔为小的冲突域**，所谓冲突域，就是指使用两个或者多个设备对网络进行分段所形成的**可共享同一带宽**的区域。交换机每个端口实际上是它自己的冲突域。

> 快速生成树协议，因交换机之间存在冗余物理链路而在数据链路层上形成的环路，路由选择协议无能为力，因此要开发生成树协议，它可以防止在第二层交换式网络形成的环路。

#### **2、交换式服务**

> 交换机能够创建私有的、专用的冲突域，并且能够在每个端口提供独立的带宽。

> 第二层交换机提供以下功能：

* 基于硬件的桥接(ASIC);
* 线速(wire);
* 低延迟;
* 低成本。

###### **2.1 第二层交换的局限性**
 
> 默认情况下，第二层交换机和网桥都不能对广播域进行分割，这一问题不仅限制网络的规模，而且还限制了网络的增长潜力，同时还会导致网络整体性能的下降。
  
###### **2.2 桥接和局域网交换机的比较**

* 网桥是基于软件的，交换机是基于硬件的，交换机使用ASIC芯片来帮助他们完成过滤决策；
* 交换机可以被视为多端口网桥；
* 每个网桥只有一个生成树实例，而交换机则可以有多个；
* 大多数交换机要比网桥的端口数量多很多；
* 网桥和交换机都将泛洪第二层广播；
* 通过检查每个接收到的数据帧的源地址，网桥和交换机完成对MAC地址的学习；
* 网桥和交换机都基于第二层地址完成转发决策。

###### **2.3 第2层上的3种交换功能**

* 地址学习:第2层交换机和网桥能够记住某个接口上所收到的每个帧的源硬件地址，而且它们还会将这个信息输入到被称为转发/过滤表的MAC数据库中
   
* 转发/过滤决策:当在某个接口收到一个数据帧时，交换机就会在MAC数据库中查看其目的方的硬件地址，并找到其输出接口。此数据帧只会被转发到相应的目的端口。
  
* 环路避免:如果为了保证冗余而在交换机之间创建多重连接，网络就可能产生环路。在提供冗余的同时，生成树协议还可以防止网络环路的产生。
  
#### **3、生成树协议(STP)**

  > STP的主要任务是防止第二层网络出现网络环路。STP首先用一个生成树算法(STA)创建一个拓扑数据库，然后找出并关闭冗余链路。运行STP后，数据帧只能在STP选定的最优链路上进行转发。

###### **3.1 生成树术语**

* 根桥：指拥有最佳桥ID的网桥。通往根桥的最佳路径上的端口就称为**根端口**。
* BPDU：桥协议数据单元，指所有交换机都需要相互交换、用于根交换机的选举，这些信息也会用于网络的后续配置。每台交换机都会对BPDUd内的参数进行比较，并将从邻居收到的BPDU放到自己的BPDU中，然后再将其转发给其他邻居。
* 桥ID：STP使用其跟踪网络中所有交换机。桥ID由优先级和MAC地址共同决定。在网络中拥有最小桥ID的网桥将成为跟桥。
* 非根桥：指出了根桥外的所有网桥。非根桥会与所有的网络交换BPDU，并在所有交换机上更新STP拓扑数据库，以防止环路并对链路失效提供保障措施。
* 端口开销:当两台交换机存在多条链路时，端口开销用于确定最佳路径。一条链路的开销取决于链路的带宽。
* 根端口：指与根桥直接相连的链路所在的端口，或者通往根桥路径开销最低的端口。如果存在连接到根桥的多条链路，那么只有检查每条链路的带宽才能确定根端口。

* 指定端口：专门指定的，通过其根端口到达根桥的最低的端口。指定端口会被标记为转发端口。
* 非指定端口：指开销比指定端口高的端口。非指定端口被标记为阻塞状态，不能进行转发。
* 转发端口：指能够进行数据转发的端口，它可以是根端口或者指定端口。
* 阻塞端口：指不能转发的端口，设为阻塞端口是为了避免环路。然而，阻塞端口会始终监听BPDU帧并丢弃其他所有的帧。

###### **3.2 生成树操作**

* 选举根桥

   根据优先级和MAC地址结合起来，校比较优先级，再比较MAC地址。在进行根桥选举时，取值越小越好。
   
* 生成树端口状态
  
   * 阻塞
   * 侦听
   * 学习
   * 转发
   * 禁用
 
   大多数情况下，交换机的端口都处于阻塞后者转发状态。

* 会聚

  当网桥或交换机上所有的端口都转换到转发或者阻塞模式时，就会形成会聚。在会聚完成之前，**无法转发数据**。会聚用于确保所有设备上都具有一个协调统一的数据库，因此会聚确实相当重要。从阻塞转换到转发模式通常会需要50秒的时间。

* 生成树端口快速(PortFast)
   
   如果交换机上连接服务器或者其他设备，并且你可以完全确定这些链路不会因为禁用STP而产生交换环路，那么，可以在这些端口使用所谓的端口快速(PortFast)。spanning-tree portfast xx.当在某个中继端口启用端口快速，就必须特别小心。
 
* 生成树的UplinkFast
   
   UplinkFast是思科产品特有的特性，当链路失效时，使用这个可用来缩短STP的会聚时间。
 
* 生成树的BackboneFast
   
   在那些无法与交换机直连的链路失效的情况下，使用这个可以加速会聚。
  
* 快速生成树协议(RSTP)802.1w
   
   802.1w重新定义了5种端口状态：
   * 禁止=**丢弃**
   * 阻塞=**丢弃**
   * 侦听=**丢弃**
   * 学习=**学习**
   * 转发=**转发**
   
* EtherChannel
  
   将多条链路捆绑在一起创建逻辑上的聚合。

#### **4、配置Catalyst交换机**

* 配置IP地址和子网掩码
  
   借助IP地址，可以对交换机进行远程管理/控制。
   
* 端口安全(port-security)
   
   端口安全可以限制能够动态连接到交换机端口的MAC地址数，也可以设置静态MAC地址，或者建立一个违规用户处罚机制。

* RSTP(802.1w)
  
   spannint-tree mode rapid-pvst
   
* EtherChannel
   
   捆绑遵循以下规则：
   
   * 相同VALN;
   * 端口处于中继模式;
   * 相同的speed和duplex.
   
* 验证思科Catalyst交换机的配置

   * sh int vlan1
   * sh mac address-table
   * sh spanning-tree
